---
description: All Vercel API routes must use Node.js runtime with VercelRequest/VercelResponse — never Edge handler signatures
globs: api/**/*.ts
alwaysApply: false
---

# Vercel API Routes: Node.js Runtime Only

Every API endpoint must use the Node.js runtime with `VercelRequest`/`VercelResponse`. Edge runtime causes `FUNCTION_INVOCATION_FAILED` crashes.

## Required pattern

```typescript
export const config = { runtime: "nodejs" };

import type { VercelRequest, VercelResponse } from "@vercel/node";

export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader("content-type", "application/json; charset=utf-8");
  // ...
  return res.status(200).json({ ok: true, data: ... });
}
```

## Forbidden patterns

- `export const config = { runtime: "edge" }` — causes module-load crashes
- `(req: Request): Promise<Response>` — Edge handler signature
- `return new Response(...)` — Edge response pattern
- `NextRequest` / `NextResponse` — Next.js Edge types
- `req.json()` — use `req.body` instead (Node.js parses automatically)
- `req.headers.get(...)` — use `req.headers[...]` (Node.js uses plain object)

## No cross-file imports in api/

Vercel's Node.js runtime with `moduleResolution: "bundler"` (from tsconfig.json)
cannot resolve cross-file TypeScript imports in the `api/` directory. Static
imports to other `.ts` files cause `FUNCTION_INVOCATION_FAILED`.

Every endpoint must be **self-contained** — inline small helpers directly:

```typescript
// ✅ GOOD — inlined in each endpoint
function setTraceHeaders(req: any, res: any) {
  const rid = (req.headers?.["x-veda-request-id"] as string) || "";
  if (rid) res.setHeader("x-veda-request-id", rid);
  res.setHeader("x-veda-handler-entered", "1");
  res.setHeader("content-type", "application/json; charset=utf-8");
}

// ❌ BAD — crashes at module load time on Vercel
import { setTraceHeaders } from "./_lib/traceHeaders";
```

Dynamic `await import()` inside try-catch is OK for optional dependencies:

```typescript
try {
  const { requireAuth } = await import("./_lib/auth");
  await requireAuth(req);
} catch { /* best-effort — fails silently if import resolution breaks */ }
```

## Response shape

All endpoints must return JSON:

```typescript
// Success
res.status(200).json({ ok: true, ... });

// Error
res.status(4xx).json({ ok: false, error: { code: "...", message: "..." } });
```

Never return `text/plain` or HTML. Even fatal errors must return JSON.
